<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Azul.js &mdash; Migrations</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Satisfy|Open+Sans:600,400,300">
    <link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/github.css">
    <link rel="stylesheet" href="/styles/application.css">
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body class="generic dev" data-spy="scroll" data-target=".navbar">
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Azul.js</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            
            <li ><a href="/#overview">Overview</a></li>
            <li ><a href="/getting-started/">Getting Started</a></li>
            
            <li class="active" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Guides <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="/guides/models/">Models</a></li>
                <li><a href="/guides/queries/">Queries</a></li>
                <li><a href="/guides/relations/">Relations</a></li>
                <li><a href="/guides/migrations/">Migrations</a></li>
                <li class="divider"></li>
                <li><a href="/guides/managers/">Managers</a></li>
                <li><a href="/guides/transactions/">Transactions</a></li>
                <li class="divider"></li>
                <li><a href="/guides/backends/">Backends</a></li>
                <li><a href="/guides/core/">Core</a></li>
                <li class="divider"></li>
                <li><a href="/guides/express/">Express Addon</a></li>
              </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://github.com/wbyoung/azul">GitHub</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
    


<div class="jumbotron">
  <div class="container">
    <h1>Migrations <a href="/releases/" class="release">dev</a></h1>
  </div>
</div>

<div class="container">
<div class="row">
<div class="col-sm-3 col-sm-push-9 guide-toc well">


  <ul>
  
    <li>
      <a href="#command-line">Command Line</a>
      <ul>
        
      </ul>
    </li>
  
    <li>
      <a href="#migration-basics">Migration Basics</a>
      <ul>
        
      </ul>
    </li>
  
    <li>
      <a href="#reversible-migrations">Reversible Migrations</a>
      <ul>
        
      </ul>
    </li>
  
    <li>
      <a href="#methods">Methods</a>
      <ul>
        
          <li>
            <a href="#methods-createtable">#createTable()</a>
            <ul>
              
                <li>
                  <a href="#methods-createtable-primarykey">#primaryKey()</a>
                </li>
              
                <li>
                  <a href="#methods-createtable-unlessexists">#unlessExists()</a>
                </li>
              
                <li>
                  <a href="#methods-createtable-with">#with()</a>
                </li>
              
                <li>
                  <a href="#methods-createtable-table-field">table#field()</a>
                </li>
              
                <li>
                  <a href="#methods-createtable-table-index">table#index()</a>
                </li>
              
            </ul>
          </li>
        
          <li>
            <a href="#methods-renametable">#renameTable()</a>
            <ul>
              
            </ul>
          </li>
        
          <li>
            <a href="#methods-altertable">#alterTable()</a>
            <ul>
              
                <li>
                  <a href="#methods-altertable-table-field">table#field()</a>
                </li>
              
                <li>
                  <a href="#methods-altertable-table-rename">table#rename()</a>
                </li>
              
                <li>
                  <a href="#methods-altertable-table-drop">table#drop()</a>
                </li>
              
                <li>
                  <a href="#methods-altertable-table-index">table#index()</a>
                </li>
              
                <li>
                  <a href="#methods-altertable-table-renameindex">table#renameIndex()</a>
                </li>
              
                <li>
                  <a href="#methods-altertable-table-dropindex">table#dropIndex()</a>
                </li>
              
            </ul>
          </li>
        
          <li>
            <a href="#methods-droptable">#dropTable()</a>
            <ul>
              
                <li>
                  <a href="#methods-droptable-ifexists">#ifExists()</a>
                </li>
              
            </ul>
          </li>
        
          <li>
            <a href="#methods-field-types">Field Types</a>
            <ul>
              
                <li>
                  <a href="#methods-field-types-serial">serial()</a>
                </li>
              
                <li>
                  <a href="#methods-field-types-integer">integer()</a>
                </li>
              
                <li>
                  <a href="#methods-field-types-integer-4">integer64()</a>
                </li>
              
                <li>
                  <a href="#methods-field-types-string">string()</a>
                </li>
              
                <li>
                  <a href="#methods-field-types-text">text()</a>
                </li>
              
                <li>
                  <a href="#methods-field-types-binary">binary()</a>
                </li>
              
                <li>
                  <a href="#methods-field-types-bool">bool()</a>
                </li>
              
                <li>
                  <a href="#methods-field-types-date">date()</a>
                </li>
              
                <li>
                  <a href="#methods-field-types-time">time()</a>
                </li>
              
                <li>
                  <a href="#methods-field-types-datetime">dateTime()</a>
                </li>
              
                <li>
                  <a href="#methods-field-types-float">float()</a>
                </li>
              
                <li>
                  <a href="#methods-field-types-decimal">decimal()</a>
                </li>
              
            </ul>
          </li>
        
          <li>
            <a href="#methods-field-options">Field Options</a>
            <ul>
              
                <li>
                  <a href="#methods-field-options-primarykey">primaryKey()</a>
                </li>
              
                <li>
                  <a href="#methods-field-options-notnull">notNull()</a>
                </li>
              
                <li>
                  <a href="#methods-field-options-unique">unique()</a>
                </li>
              
                <li>
                  <a href="#methods-field-options-default">default()</a>
                </li>
              
                <li>
                  <a href="#methods-field-options-references">references()</a>
                </li>
              
                <li>
                  <a href="#methods-field-options-ondelete">onDelete()</a>
                </li>
              
                <li>
                  <a href="#methods-field-options-ondelete">onDelete()</a>
                </li>
              
            </ul>
          </li>
        
      </ul>
    </li>
  
  </ul>


</div>
<div class="col-sm-8 col-sm-pull-3">

<h1 id="migrations">Migrations</h1>
<h2 id="command-line">Command Line</h2>
<p>The <code>azul</code> command line tool can be used both to quickly create migrations as
well as to run the migrations.</p>
<p>To create a new migration:</p>
<pre><code class="hljs bash">$ azul make-migration create-articles</code></pre>

<p>The migration file will be empty. You&apos;ll fill it in with schema changes that
you want to make in this migration. Once completed, you can run your migrations
with the command line tool, and roll them back as needed.</p>
<pre><code class="hljs bash">$ azul migrate
$ azul rollback</code></pre>

<h2 id="migration-basics">Migration Basics</h2>
<p>Migrations are sequences of changes that are made to your database schema over
time. They allow a team of developers to work together more fluidly. Each
migration is applied in the order in which it was created. It is assumed that
once created and applied, that migrations do not change. That is, once you
commit a migration and push it, you should not change it. You should instead
create a new migration.</p>
<p>Azul.js migrations are simply modules that export two functions, an <code>up</code>
function and a <code>down</code> function. When you migrate your database schema forward,
you&apos;ll run <code>azul migrate</code> and the <code>up</code> will be run. When you migrate your
schema backward, you&apos;ll run <code>azul rollback</code> and the <code>down</code> function will be
run. It is expected that your <code>down</code> function reverse the changes that your up
function makes.</p>
<p>An example migration looks like this:</p>
<pre><code class="hljs js">exports.up = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(schema)</span> </span>{
  schema.createTable(<span class="hljs-string">&apos;articles&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(table)</span> </span>{
    table.string(<span class="hljs-string">&apos;title&apos;</span>);
    table.text(<span class="hljs-string">&apos;body&apos;</span>);
  });
};

exports.down = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(schema)</span> </span>{
  schema.dropTable(<span class="hljs-string">&apos;articles&apos;</span>);
};</code></pre>

<p>In fact, Azul.js is able to determine how to <a href="#reversible-migrations">reverse many
migrations</a>. For these migrations, you&apos;ll only need to
export a <code>change</code> function. The above example is reversible and could simply be
written:</p>
<pre><code class="hljs js">exports.change = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(schema)</span> </span>{
  schema.createTable(<span class="hljs-string">&apos;articles&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(table)</span> </span>{
    table.string(<span class="hljs-string">&apos;title&apos;</span>);
    table.text(<span class="hljs-string">&apos;body&apos;</span>);
  });
};</code></pre>

<p>For examples of running multiple actions in a single migration, see the example
migrations discussed in the <a href="/guides/relations/#types-of-relationships-one-to-many">relations
documentation</a>.</p>
<p>Migrations are run inside of a transaction, so if any of the migrations in a
sequence of migrations fails, the entire group will be rolled back. This is
only true if your database supports transactions.</p>
<p>The <code>up</code> and <code>down</code> functions are provided with a second argument. A
<a href="/guides/queries/#data-queries">basic query</a> object that you can use if you need to
execute raw SQL or perform schema changes that are not supported by Azul.js.</p>
<p>Migrations support two modes of execution, <em>sequential</em> and <em>manual</em>. The
examples given above are sequential. Each schema change will be executed
in the order they are written. In this mode, you cannot write asynchronous code
(no callbacks or promises). You therefore cannot obtain the results of any
queries. If you need full control, <em>manual</em> mode can be enabled by simply
returning a promise or <em>thenable</em> from the from the <code>up</code> or <code>down</code> function. In
manual mode, you are responsible for executing all queries in your migration.</p>
<h2 id="reversible-migrations">Reversible Migrations</h2>
<p>Azul.js is able to determine the reverse of migrations that do not make
destructive changes. For instance, <em>creating</em> a table can be reversed because
no additional information is needed to know that the reverse is to remove that
table. On the other hand, if you write a migration to drop a table, more
information would be needed to know how to re-create the table. Operations
that <em>rename</em> will also be reversible.</p>
<p>Each method below will discuss in more detail whether it can be used with the
<code>change</code> function.</p>
<h2 id="methods">Methods</h2>
<h3 id="methods-createtable"><code>#createTable(name, [cb])</code></h3>
<p>Create new tables. Pass the name of the table you want to create and a callback
that will receive a table object with which you will be able to create columns
of different <a href="#methods-field-types">field types</a>.</p>
<pre><code class="hljs js">schema.createTable(<span class="hljs-string">&apos;articles&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(table)</span> </span>{
  table.string(<span class="hljs-string">&apos;title&apos;</span>);
  table.text(<span class="hljs-string">&apos;body&apos;</span>);
});</code></pre>

<p>This method is always <a href="#reversible-migrations"><em>reversible</em></a>.</p>
<p>Returns a <em>thenable</em> <a href="/guides/queries/#data-queries">basic query</a> with the
following chainable methods:</p>
<h4 id="methods-createtable-primarykey"><code>#primaryKey(column)</code> or <code>#pk</code></h4>
<p>Defines the primary key of the table. The default is <code>id</code>. Pass
<code>null</code> to create a table without a primary key. You can configure the primary
key&apos;s type or options within your table definition callback. See below for an
example.</p>
<h4 id="methods-createtable-unlessexists"><code>#unlessExists()</code></h4>
<p>Will not create the table if it already exists.</p>
<h4 id="methods-createtable-with"><code>#with(cb)</code></h4>
<p>Allows delayed definition of the table columns &amp; indexes.</p>
<pre><code class="hljs js">schema.createTable(<span class="hljs-string">&apos;articles&apos;</span>)
.pk(<span class="hljs-string">&apos;identifier&apos;</span>)
.unlessExists()
.with(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(table)</span> </span>{
   table.serial(<span class="hljs-string">&apos;identifier&apos;</span>).notNull(); <span class="hljs-comment">// pk</span>
   table.string(<span class="hljs-string">&apos;title&apos;</span>);
});</code></pre>

<h4 id="methods-createtable-table-field"><code>table#field(column, [options])</code></h4>
<p>Create a column of the type given by <code>field</code>. See
<a href="#methods-field-types">field types</a> for a comprehensive list of types, options,
and examples.</p>
<h4 id="methods-createtable-table-index"><code>table#index(columns, [options])</code></h4>
<p>Add an index to the table.</p>
<pre><code class="hljs js">table.index(<span class="hljs-string">&apos;boss_id&apos;</span>); <span class="hljs-comment">// name automatically set to table_boss_id_idx</span>
table.index([<span class="hljs-string">&apos;first_name&apos;</span>, <span class="hljs-string">&apos;last_name&apos;</span>], { name: <span class="hljs-string">&apos;full_name_index&apos;</span> });</code></pre>


<h3 id="methods-renametable"><code>#renameTable(from, to)</code></h3>
<p>Rename a table.</p>
<pre><code class="hljs js">schema.renameTable(<span class="hljs-string">&apos;articles&apos;</span>, <span class="hljs-string">&apos;posts&apos;</span>);</code></pre>

<p>This method is always <a href="#reversible-migrations"><em>reversible</em></a>.</p>
<h3 id="methods-altertable"><code>#alterTable(table, cb)</code></h3>
<p>Alter existing tables. Pass the name of the table you want to alter and a
callback that will receive a table object with which you will be able to
create columns of different <a href="#methods-field-types">field types</a> as
well as drop existing columns.</p>
<pre><code class="hljs js">schema.alterTable(<span class="hljs-string">&apos;articles&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(table)</span> </span>{
  table.string(<span class="hljs-string">&apos;title&apos;</span>); <span class="hljs-comment">// add a title column</span>
  table.drop(<span class="hljs-string">&apos;body&apos;</span>); <span class="hljs-comment">// drop the body column</span>
});</code></pre>

<p>This method is <a href="#reversible-migrations"><em>reversible</em></a> unless you
use <a href="#methods-altertable-table-drop"><code>drop</code></a> to drop a column or
<a href="#methods-altertable-table-dropindex"><code>dropIndex</code></a> to drop an index.</p>
<h4 id="methods-altertable-table-field"><code>table#field(column, [options])</code></h4>
<p>Create a column of the type given by <code>field</code>. See
<a href="#methods-field-types">field types</a> for a comprehensive list of types, options,
and examples.</p>
<h4 id="methods-altertable-table-rename"><code>table#rename(from, to)</code></h4>
<p>Renames a table column.</p>
<p>While not intuitive, a third argument, <code>type</code>, is required for a rename. This
is because certain backends need this value in order to perform a rename. The
value of the type <em>must match</em> the type used to create the column.</p>
<pre><code class="hljs js">schema.alterTable(<span class="hljs-string">&apos;articles&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(table)</span> </span>{
  table.rename(<span class="hljs-string">&apos;title&apos;</span>, <span class="hljs-string">&apos;headline&apos;</span>, <span class="hljs-string">&apos;string&apos;</span>); <span class="hljs-comment">// rename the title column</span>
});</code></pre>

<h4 id="methods-altertable-table-drop"><code>table#drop(column)</code></h4>
<p>Drops a table column.</p>
<pre><code class="hljs js">schema.alterTable(<span class="hljs-string">&apos;articles&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(table)</span> </span>{
  table.drop(<span class="hljs-string">&apos;title&apos;</span>); <span class="hljs-comment">// drop the title column</span>
});</code></pre>

<p>This is not <a href="#reversible-migrations"><em>reversible</em></a>.</p>
<h4 id="methods-altertable-table-index"><code>table#index(columns, [options])</code></h4>
<p>Add an index to the table. See
<a href="#methods-createtable-table-index">create table examples</a>.</p>
<h4 id="methods-altertable-table-renameindex"><code>table#renameIndex(from, to)</code></h4>
<p>Rename an index associated with a table. The full index name must be provided.</p>
<pre><code class="hljs js">schema.alterTable(<span class="hljs-string">&apos;employees&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(table)</span> </span>{
  table.renameIndex(<span class="hljs-string">&apos;full_name_index&apos;</span>, <span class="hljs-string">&apos;full_name_idx&apos;</span>);
});</code></pre>

<h4 id="methods-altertable-table-dropindex"><code>table#dropIndex([columns], [options])</code></h4>
<p>Drops an index associated with a table.</p>
<pre><code class="hljs js">schema.alterTable(<span class="hljs-string">&apos;employees&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(table)</span> </span>{
  table.dropIndex(<span class="hljs-string">&apos;boss_id&apos;</span>); <span class="hljs-comment">// drops employees_boss_id_idx</span>
  table.dropIndex({ name: <span class="hljs-string">&apos;full_name_index&apos;</span> }); <span class="hljs-comment">// drops full_name_index</span>
});</code></pre>

<p>This is not <a href="#reversible-migrations"><em>reversible</em></a>.</p>
<h3 id="methods-droptable"><code>#dropTable(table)</code></h3>
<p>Drop existing tables.</p>
<pre><code class="hljs js">schema.dropTable(<span class="hljs-string">&apos;articles&apos;</span>);</code></pre>

<p>This method is never <a href="#reversible-migrations"><em>reversible</em></a>.</p>
<p>Returns a <em>thenable</em> <a href="/guides/queries/#data-queries">basic query</a> with the
following chainable methods:</p>
<h4 id="methods-droptable-ifexists"><code>#ifExists()</code></h4>
<p>Will only drop the table if it exists.</p>
<h3 id="methods-field-types">Field Types</h3>
<h4 id="methods-field-types-serial"><code>serial(column)</code></h4>
<p>Automatically incrementing integer type usually used for <code>id</code> primary key
columns.</p>
<p>You can also use one of the following aliases:</p>
<ul>
<li><code>auto</code></li>
<li><code>increments</code></li>
</ul>
<h4 id="methods-field-types-integer"><code>integer(column)</code></h4>
<p>Standard sized integer.</p>
<h4 id="methods-field-types-integer-4"><code>integer64(column)</code></h4>
<p>64 bit integer.</p>
<h4 id="methods-field-types-string"><code>string(column, [options])</code></h4>
<p>A string. Accepts a <code>length</code> option which defaults to <code>255</code>.</p>
<pre><code class="hljs js">table.string(<span class="hljs-string">&apos;title&apos;</span>, { length: <span class="hljs-number">80</span> });</code></pre>

<h4 id="methods-field-types-text"><code>text(column)</code></h4>
<p>Arbitrary length (long) text.</p>
<h4 id="methods-field-types-binary"><code>binary(column)</code></h4>
<p>Binary data.</p>
<h4 id="methods-field-types-bool"><code>bool(column)</code></h4>
<p>Boolean.</p>
<h4 id="methods-field-types-date"><code>date(column)</code></h4>
<p>A date type that does not include a time.</p>
<p><em>Quirks in <a href="/guides/backends/#sqlite3-date">SQLite3</a>.</em></p>
<h4 id="methods-field-types-time"><code>time(column)</code></h4>
<p>A time type that does not include a date.</p>
<p><em>Quirks in <a href="/guides/backends/#sqlite3-time">SQLite3</a>.</em></p>
<h4 id="methods-field-types-datetime"><code>dateTime(column)</code></h4>
<p>A date and type type. Sometimes also known as a <em>timestamp</em>, this may or may
not use a <em>timestamp</em> type depending on the database back-end, but will contain
both the date and time components of a date.</p>
<p><em>Quirks in <a href="/guides/backends/#sqlite3-datetime">SQLite3</a>.</em></p>
<h4 id="methods-field-types-float"><code>float(column)</code></h4>
<p>A floating point number.</p>
<h4 id="methods-field-types-decimal"><code>decimal(column, [options])</code></h4>
<p>A decimal type that accepts the options <code>precision</code> and <code>scale</code>.</p>
<pre><code class="hljs js">table.decimal(<span class="hljs-string">&apos;amount&apos;</span>, { precision: <span class="hljs-number">20</span>, scale: <span class="hljs-number">10</span> });</code></pre>

<p>If using options, you must specify at least the precision. Different adapters
will handle options slightly differently. It is recommended to either omit both
the <code>precision</code> and the <code>scale</code> or provide both for most consistent results.</p>
<h3 id="methods-field-options">Field Options</h3>
<p>Options are enabled by chaining any of the following methods onto the end of
the field definition as shown in
<a href="#methods-createtable">the create table example</a>.</p>
<h4 id="methods-field-options-primarykey"><code>primaryKey()</code> or <code>pk()</code></h4>
<p>Mark this column as being a primary key column.</p>
<h4 id="methods-field-options-notnull"><code>notNull()</code></h4>
<p>Mark this column as not accepting null values.</p>
<h4 id="methods-field-options-unique"><code>unique()</code></h4>
<p>Mark this column as containing unique values.</p>
<h4 id="methods-field-options-default"><code>default(value)</code></h4>
<p>Set the default value for this column.</p>
<pre><code class="hljs js">table.string(<span class="hljs-string">&apos;name&apos;</span>).default(<span class="hljs-string">&apos;Anonymous&apos;</span>)</code></pre>

<p><em>Security Note:</em> This method accepts only number and strings. Azul.js will
escape the value that&apos;s sent to it to prevent security vulnerabilities, but we
still recommend against sending user-input to this method.</p>
<h4 id="methods-field-options-references"><code>references(reference)</code></h4>
<p>Set the column that this column references.</p>
<pre><code class="hljs js">table.integer(<span class="hljs-string">&apos;article_id&apos;</span>).references(<span class="hljs-string">&apos;articles.id&apos;</span>)</code></pre>

<h4 id="methods-field-options-ondelete"><code>onDelete(action)</code></h4>
<p>Set the delete action for a foreign key set up with
<a href="#methods-field-options-references"><code>references</code></a>. The action must be one of
<code>cascade</code>, <code>restrict</code>, or <code>nullify</code>.</p>
<h4 id="methods-field-options-ondelete"><code>onDelete(action)</code></h4>
<p>Set the update action for a foreign key set up with
<a href="#methods-field-options-references"><code>references</code></a>. The action must be one of
<code>cascade</code>, <code>restrict</code>, or <code>nullify</code>.</p>


</div>
</div>
</div>




    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  </body>
</html>
